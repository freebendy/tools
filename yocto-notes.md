# Concept
## layer
The OpenEmbedded build system supports organizing Metadata into multiple layers. Layers allow you to isolate different types of customizations from each other. You might find it tempting to keep everything in one layer when working on a single project. However, the more modular your Metadata, the easier it is to cope with future changes. 

References:
- http://www.yoctoproject.org/docs/2.3/dev-manual/dev-manual.html#understanding-and-creating-layers
- http://www.yoctoproject.org/docs/2.3/bsp-guide/bsp-guide.html#bsp
- http://www.yoctoproject.org/docs/2.2.1/ref-manual/ref-manual.html#metadata-machine-configuration-and-policy-configuration

## recipe
Each software component built by the OpenEmbedded build system requires a recipe to define the component.

References:
- http://www.yoctoproject.org/docs/2.2.1/ref-manual/ref-manual.html#normal-recipe-build-tasks
- http://www.yoctoproject.org/docs/2.3/dev-manual/dev-manual.html#new-recipe-writing-a-new-recipe
- https://www.openembedded.org/wiki/Styleguide
- http://www.yoctoproject.org/docs/2.2.1/ref-manual/ref-manual.html#ref-varlocality-recipes

## machine
Specifies the hardware information for target device.

References:
- http://www.yoctoproject.org/docs/2.2.1/ref-manual/ref-manual.html#ref-features-machine
- http://www.yoctoproject.org/docs/2.3/dev-manual/dev-manual.html#platdev-newmachine

## package
Generated by the build of a recipe. Normally, the build oupout of a recipe contains multiple packages.

References:
- http://www.yoctoproject.org/docs/2.2.1/ref-manual/ref-manual.html#var-FILES

## package group
A configuration to group packages.

References:
- http://www.yoctoproject.org/docs/2.3/dev-manual/dev-manual.html#usingpoky-extend-customimage-customtasks

## image
Produced by the OpenEmbedded build system are compressed forms of the root filesystem that are ready to boot on a target device. It is also configured via a recipe.

- http://www.yoctoproject.org/docs/2.2.1/ref-manual/ref-manual.html#images-dev-environment
- http://www.yoctoproject.org/docs/2.3/dev-manual/dev-manual.html#usingpoky-extend-customimage

# Commands
Show the package dependency for image: `bitbake <image > -g -u depexp`

Open a new shell where with neccesary system values already defined for package: `bitbake <package> -c  devshell`

Interactive kernel configuration: `bitbake virtual/kernel -c menuconfig`

Fetch sources for a particular image: `bitbake <image> -c fetchall`

Show possible images to bake. Without "*-images-*", it shows ALL recipes: `bitbake-layers show-recipes "*-image-*"`

Show image's packages: `bitbake -g <image> && cat pn-depends.dot | grep -v -e '-native' | grep -v digraph | grep -v -e '-image' | awk '{print $1}' | sort | uniq`

Show package's dependencies: `bitbake -g <pkg> && cat pn-depends.dot | grep -v -e '-native' | grep -v digraph | grep -v -e '-image' | awk '{print $1}' | sort | uniq`

Print (on console) and store verbose baking: `bitbake –v <image> 2>&1 | tee image_build.log`

Check if certain package is present on current Yocto Setup: `bitbake -s | grep <pkg>`

Check pakacged included in arecipe： `bitbake -e RECIPE_NAME | grep ^PACKAGES=`

Check the environment of a recipe: `bitbake -e <RECIPE> | less`

List targets: `ls meta*/recipes*/images/*.bb`

List machines: `ls meta*/conf/machine/*.conf`

List recipes： `ls meta*/recipes*/*/*.bb`

List packagegroups: `ls meta*/recipes*/packagegroups/packagegroup*.bb`

List kernels: `ls meta*/recipes-kernel/linux/*.bb`

Force execution of a task： bitbake <target> -c <task> -f

List tasks： bitbake <target> -c listtasks

Execute special task: `bitbake <target> -c <task>` (without do_)

Generate package dependency： `bitbake -g <target>` (pn-buildlist, pn-depends.dot, package-depends.dot, and task-depends.dot), human-readable格式： `bitbake -g -u depexp <target>`

Increse debug level via adding option `D`, .e.g. `-DDD`


# Notes

Image directory: `$BUILD_DIR/tmp/deploy/images`

Log directory: `${WORKDIR}/temp/`


Logging inrecipe (Refer to poky/meta/classes/logging.bbclass)
- Python: bb.fatal, bb.error, bb.warn, bb.note, bb.plain, and bb.debug
- Bash: bfatal, bberror, bbwarn, bbnote, bbplain, and bbdebug

Important variables in a recipe:
- PN: name of the built package
- BPN: This variable is a version of the PN variable with common prefixes and suffixes removed, such as nativesdk-, -cross, -native, and multilib's lib64- and lib32-.
- PV: version of the recipe to build the package
- PR: revision of the recipe to build the package，默认值:r0
- PF: ${PN}-${EXTENDPE}${PV}-${PR}

Directories:
- TOPDIR: or BUILDDIR, parameter of ". oe-init-build-env", default value is poky/build
- TMPDIR: The base directory where the OpenEmbedded build system performs all its work during the build. (${TOPDIR}/tmp)
- WORKDIR: The location within TMPDIR where a specific package is built. (${TMPDIR}/work/${MULTIMACH_TARGET_SYS}/${PN}/${EXTENDPE}${PV}-${PR})
- DEPLOYDIR: ${WORKDIR}/deploy-${PN}
- DL_DIR: ${TOPDIR}/downloads
- LOG_DIR: ${TMPDIR}/log
- ERR_REPORT_DIR: ${LOG_DIR}/error-report
- S: ({WORKDIR}/${PN}-${PV})
- D: (${WORKDIR}/image)
- B: diretort for object files, same as `S` by defauly
- DEPLOY_DIR: ${TMPDIR}/deploy
- THISDIR: The directory in which the file BitBake is currently parsing is located. Do not manually set this variable. 

Layers：
- Distro layer - Distribution Layers provide top-level or general policies for the image or SDK being built.
- BSP layer - Board Support Package (BSP) layers provide machine configurations. This type of information is specific to a particular target architecture.
- Software layer - Software layers contain user-supplied recipe files, patches, and append files.
    
BitBake handles the parsing and execution of the data files:
- Recipes: Provides details about particular pieces of software. (.bb)
- Class Data: Abstracts common build information (e.g. how to build a Linux kernel).(.bbclass)
- Configuration Data: Defines machine-specific settings, policy decisions, and so forth. Configuration data acts as the glue to bind everything together (.conf).

Directory hierarchy：
- meta： OpenEmbedded Core metadata - recipes, common classes, and machine configuration for emulated targets
- meta-yocto: the configuration for the Poky reference distribution (there are examples)
- meta-yocto-bsp: the Yocto Project reference hardware Board Support Packages
- meta-selftest: additional recipes and append files used by the OpenEmbedded selftests to verify the behavior of the build system. Add this layer to your bblayers.conf file if you want to run the selftests

The name of recipe cannot contain "_", because "_" is used to seprate ${PN} and ${PV}

BBFILE_PRIORITY: 
- 为每个layer中的recipe files(.bb文件)指定优先级。　值越大优先级越高。
- 如果同一个recipe在多个layer中出现，设置这个变量会忽视recipe的版本号（PV,优先级相同会使用高版本号的recipe）
- 如果没有指定这个变量，它的值会基于layer依赖。
- 如果没有指定和没有任何依赖，默认是最低优先级+1(或者是１如果没有指定任何优先级)
- "bitbake-layers show-layers"显示有配置的layer的优先级。

如果一个recipe有多个bbappend,它们的patch顺序怎么决定？ ("bitbake-layers show-appends"显示bbappend文件),受layer优先级的影响(BBFILE_PRIORITY).

Add a pakckage to image:
- CORE_IMAGE_EXTRA_INSTALL += (used in local.conf )
- IMAGE_INSTALL_append = (used in image recipe)
- EXTRA_IMAGE_FEATURES += (used in local.conf )

Prefer a specific version of the recipe: PREFERRED_VERSION_${PN} = "${PV}", 指定package的版本，${PV}中可以使用%当通配符.

Predefined variables： poky/meta/conf/bitbake.conf

Important directories:
- poky/meta/classes
- poky/meta/conf
- meta/recipes-core/packagegroups
- meta/recipes-core/images

python modules：
- poky/bitbake/lib
- poky/meta/lib

LICENSE directory: stardard licenses are placed in meta/files/common-licenses/, the SPDXLICENSEMAP flag names defined in meta/conf/licenses.conf (http://www.yoctoproject.org/docs/1.8/dev-manual/dev-manual.html#new-recipe-licensing)

Features:
- MACHINE_FEATURES: normally defined in the machine definition files
- DISTRO_FEATURES: normally in meta*/conf/distro, e.g. poky/meta-yocto/conf/distro & poky/meta/conf/distro 
- IMAGE_FEATURES: (poky/meta/classes/core-image.bbclass)
- COMBINED_FEATURES: Provides a list of hardware features that are enabled in both MACHINE_FEATURES and DISTRO_FEATURES.
- CONFLICT_DISTRO_FEATURES: if the CONFLICT_DISTRO_FEATURES variable lists a feature that also appears in DISTRO_FEATURES within the current configuration, an error occurs and the build stops. (distro_features_check.bbclass)
- REQUIRED_DISTRO_FEATURES: if the REQUIRED_DISTRO_FEATURES variable lists a feature that does not appear in DISTRO_FEATURES within the current configuration, an error occurs and the build stops. (distro_features_check.bbclass)
- ref: (http://www.crashcourse.ca/wiki/index.php/Poky_MACHINE_DISTRO_FEATURES, http://www.yoctoproject.org/docs/1.8/ref-manual/ref-manual.html#ref-features)


如何改变image大小？
- 在meta/conf/bitbake.conf中定义IMAGE_ROOTFS_EXTRA_SPACE，可以在local.conf中使用这个配置来增加额外的空间
- 直接在local.conf重新定义IMAGE_ROOTFS_SIZE的大小，原来定义在images/<TARGET>.bb 和meta/conf/bitbake.conf （默认65MB * 1.3）
- http://guy.carpenter.id.au/chumby-oe/blog/2012/03/29/using-all-of-the-sd-card/ and http://wiki.chumby.com/index.php?title=Advanced_OpenEmbedded
    
    
自定义image相关的几个重要文件：
- 从/poky/meta/classes/core-image.bbclass继承
- core-image.bbclass继承自image.bbclass


IMAGE_FSTYPES配置生成什么格式的根文件系统（poky/meta/classes/image_types.bbclass）.

如果不想kernel被包含在image中，RDEPENDS_kernel-base = "" (refer to poky/meta/classes/kernel.bbclass)

指定kernel（在machine的conf文件里）
- KERNEL_IMAGETYPE = "zImage"
- KERNEL_DEVICETREE = "${S}/arch/arm/boot/dts/myTree.dtb"
- KERNEL_EXTRA_ARGS += "LOADADDR=${UBOOT_ENTRYPOINT}"
- PREFERRED_PROVIDER_virtual/kernel = "linux-yocto"
- PREFERRED_VERSION_linux-yocto = "4.9%"
